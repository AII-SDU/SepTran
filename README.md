# TaskLevel Lang MultiBackendï¼šåŸºäºé€»è¾‘æ˜ å°„åˆ†ç¦»çš„AIç¼–è¯‘å™¨æ¡†æ¶

<div align="center">

[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)
[![Python](https://img.shields.io/badge/Python-3.8%2B-blue)](https://www.python.org/)
[![TVM](https://img.shields.io/badge/Based%20on-TVM-orange)](https://tvm.apache.org/)
[![Status](https://img.shields.io/badge/Status-Planning-yellow.svg)](https://github.com/your-org/tasklevel-lang-multibackend)

**ğŸš§ é¡¹ç›®è§„åˆ’ä¸­ ğŸš§**  
**ä¸€ä¸ªé©å‘½æ€§çš„AIç¼–è¯‘å™¨æ¡†æ¶ï¼Œå½»åº•åˆ†ç¦»ç®—æ³•é€»è¾‘ä¸ç¡¬ä»¶æ˜ å°„ï¼Œä¸€æ¬¡ç¼–å†™ï¼Œå¤šç«¯éƒ¨ç½²**

</div>

## ğŸš€ é¡¹ç›®æ„¿æ™¯

TaskLevel Lang MultiBackend ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œæ·±åº¦å€Ÿé‰´äº† [TileLang](https://github.com/tile-ai/tilelang) çš„è§£è€¦æ€æƒ³å’Œ TVM TensorIR çš„è®¾è®¡ç†å¿µï¼ŒåŒæ—¶åˆ›æ–°æ€§åœ°å¼•å…¥äº† [Cypress è®ºæ–‡](https://rohany.github.io/publications/pldi2025-cypress.pdf) "é€»è¾‘ä¸æ˜ å°„åˆ†ç¦»" çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ„å»ºäº†ä¸€ä¸ªå…¨æ–°çš„AIç¼–è¯‘å™¨æ¡†æ¶ã€‚

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯**å½»åº•è§£å†³AIç¼–è¯‘å™¨çš„NÃ—Må¤æ‚åº¦é—®é¢˜**ï¼šè®©å¼€å‘è€…ä¸ºNä¸ªç®—å­é€»è¾‘ç¼–å†™ä¸€æ¬¡ä»£ç ï¼Œé€šè¿‡Mä¸ªç¡¬ä»¶æ˜ å°„æ–‡ä»¶å³å¯é€‚é…æ‰€æœ‰ç›®æ ‡ç¡¬ä»¶ï¼Œä»æ ¹æœ¬ä¸Šè§£å†³AIç¼–è¯‘å™¨çš„å¯ç§»æ¤æ€§æŒ‘æˆ˜ã€‚

### ğŸ¯ æ ¸å¿ƒä»·å€¼
- **ğŸ”„ å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šç®—æ³•é€»è¾‘ä¸ç¡¬ä»¶ä¼˜åŒ–å®Œå…¨è§£è€¦
- **ğŸ“ˆ çº¿æ€§æ‰©å±•æ€§**ï¼šä»NÃ—Må¤æ‚åº¦é™ä½åˆ°N+M
- **âš¡ å¼€å‘æ•ˆç‡**ï¼šä¸€æ¬¡ç¼–å†™ï¼Œå¤šç«¯éƒ¨ç½²
- **ğŸ›ï¸ ä¸“å®¶å‹å¥½**ï¼šç¡¬ä»¶ä¸“å®¶å¯ç‹¬ç«‹ä¼˜åŒ–æ˜ å°„æ–‡ä»¶

## ğŸ—ï¸ æ¶æ„è®¾è®¡

TaskLevel Lang MultiBackend é‡‡ç”¨åˆ›æ–°çš„ä¸‰å±‚æ¶æ„è®¾è®¡ï¼ŒåŸºäº [TVM](https://tvm.apache.org/) ç”Ÿæ€æ„å»ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€»è¾‘å±‚ (Task Langå‰ç«¯)                    â”‚
â”‚    âœ¨ çº¯ç²¹çš„ã€å±‚æ¬¡åŒ–çš„è®¡ç®—ä»»åŠ¡æè¿°ï¼Œå®Œå…¨ç¡¬ä»¶æ— å…³            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ˜ å°„å±‚ (ç¡¬ä»¶æ˜ å°„æ–‡ä»¶)                      â”‚
â”‚    ğŸ¯ å£°æ˜å¼çš„ç¡¬ä»¶æ˜ å°„è§„èŒƒï¼Œä¸“å®¶ç¼–å†™çš„æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç¼–è¯‘å™¨ (æ™ºèƒ½çš„æ˜ å°„å¤„ç†å™¨)                     â”‚
â”‚    ğŸ§  æ˜ å°„æŒ‡å¯¼ä¸‹çš„ä»£ç ç”Ÿæˆï¼Œè‡ªåŠ¨èåˆé€»è¾‘ä¸æ˜ å°„              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â¬‡ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               TVM IR + è‡ªå®šä¹‰ CodeGen                       â”‚
â”‚    âš™ï¸ ç”ŸæˆåŒ…å«ç¡¬ä»¶åº“è°ƒç”¨çš„ TVM TensorIRï¼Œè½¬è¯‘ä¸º C åº“è°ƒç”¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’» æŠ€æœ¯è®¾è®¡

### ç¬¬ä¸€æ­¥ï¼šç¼–å†™ç¡¬ä»¶æ— å…³çš„é€»è¾‘ä»£ç 

```python
import task_lang as task

# å¶å­ä»»åŠ¡ï¼šçº¯ç²¹çš„é€»è¾‘æè¿°ï¼Œæ— ç¡¬ä»¶ç›¸å…³ä»£ç 
@task.define(leaf=True)
def gemm_leaf_logic(C, A, B):
    """GEMMå¶å­ä»»åŠ¡çš„é€»è¾‘å®šä¹‰"""
    task.call_primitive("gemm", C, A, B)

# å¤åˆä»»åŠ¡ï¼šå±‚æ¬¡åŒ–çš„ç®—æ³•åˆ†è§£
@task.define
def gemm_block_logic(C, A, B):
    """GEMMå—çº§ä»»åŠ¡çš„é€»è¾‘åˆ†è§£"""
    # çº¯ç²¹çš„é€»è¾‘åˆ†è§£ï¼šå°†å¤§é—®é¢˜åˆ†è§£æˆå°é—®é¢˜
    Cp = task.partition(C, by="blocks", shape_from="A")
    Ap = task.partition(A, by="blocks", shape_from="A") 
    Bp = task.partition(B, by="blocks", shape_from="A")
    
    # å¯åŠ¨ä¸‹ä¸€å±‚çº§çš„ä»»åŠ¡
    for i, j in task.parallel_range(Cp.shape):
        task.launch(gemm_leaf_logic, Cp[i,j], Ap[i,:], Bp[:,j])
```

### ç¬¬äºŒæ­¥ï¼šç¼–å†™ç¡¬ä»¶æ˜ å°„æ–‡ä»¶

```yaml
# gemm_on_nvidia_gpu.mapping.yaml
entrypoint: gemm_host

task_mappings:
  gemm_host:
    task_name: gemm_host_logic
    proc: HOST
    mems: {C: GLOBAL, A: GLOBAL, B: GLOBAL}
    tunables: {block_size: 128}
    calls: {gemm_block_logic: gemm_block_gpu}

  gemm_block_gpu:
    task_name: gemm_block_logic
    proc: BLOCK
    # æ ¸å¿ƒæŒ‡ä»¤ï¼šAå’ŒBæ”¾åˆ°SHAREDå†…å­˜ï¼Œå¯ç”¨æµæ°´çº¿
    mems: {C: REGISTER, A: SHARED, B: SHARED}
    pipeline: 3
    leaf_task_bindings:
      gemm_leaf_logic: gemm_leaf_tensorcore
```

### ç¬¬ä¸‰æ­¥ï¼šæ™ºèƒ½ç¼–è¯‘è¿‡ç¨‹

#### æ˜ å°„æŒ‡å¯¼ä¸‹çš„ TVM TensorIR ç”Ÿæˆ

ç¼–è¯‘å™¨ä»å…¥å£ç‚¹å¼€å§‹ï¼Œé€’å½’éå†é€»è¾‘ä»»åŠ¡æ ‘ï¼Œåœ¨æ¯ä¸ª `task.launch(callee, ...)` èŠ‚ç‚¹ï¼š

1. **æŸ¥è¯¢æ˜ å°„æ–‡ä»¶**ï¼šç¡®å®šè¢«è°ƒç”¨ä»»åŠ¡åº”è¯¥ä½¿ç”¨å“ªä¸ªæ˜ å°„å®ä¾‹
2. **åˆ†æå†…å­˜éœ€æ±‚**ï¼šè¯»å–æ˜ å°„å®ä¾‹çš„ `mems` å­—æ®µï¼Œäº†è§£å†…å­˜è¦æ±‚
3. **å¯¹æ¯”ä¸å†³ç­–**ï¼šå‘ç°å†…å­˜ç©ºé—´ä¸åŒ¹é…æ—¶è‡ªåŠ¨å†³ç­–
4. **è‡ªåŠ¨æ’å…¥åŸè¯­**ï¼šè‡ªåŠ¨åœ¨ç”Ÿæˆçš„ IR ä¸­æ’å…¥å¿…è¦çš„æ“ä½œ

**ç”Ÿæˆçš„ TVM TensorIR ç¤ºä¾‹ï¼š**

```python
@T.prim_func
def generated_kernel(
    A: T.handle, B: T.handle, C: T.handle,
    a_scratch: T.handle, b_scratch: T.handle
):
    A_buffer = T.match_buffer(...)
    B_buffer = T.match_buffer(...)
    C_buffer = T.match_buffer(...)
    A_scratch_buffer = T.match_buffer(...)
    B_scratch_buffer = T.match_buffer(...)

    # ç¼–è¯‘å™¨æ ¹æ®æ˜ å°„æ–‡ä»¶è‡ªåŠ¨æ’å…¥çš„ DMA æ“ä½œ
    T.evaluate(T.call_extern(
        "dsa.dma_copy", A_buffer, A_scratch_buffer, dtype="void"
    ))
    T.evaluate(T.call_extern(
        "dsa.dma_copy", B_buffer, B_scratch_buffer, dtype="void"
    ))

    # è‡ªåŠ¨æ’å…¥çš„åŒæ­¥æ“ä½œ
    T.evaluate(T.call_extern("dsa.sync", dtype="void"))

    # æ ¸å¿ƒè®¡ç®—
    T.evaluate(T.call_extern(
        "dsa.mma", C_buffer, A_scratch_buffer, B_scratch_buffer, dtype="void"
    ))
```

#### è‡ªå®šä¹‰ TVM CodeGen

ç»§æ‰¿ TVM ç°æœ‰çš„ `CodeGenC`ï¼Œåˆ›å»ºè‡ªå®šä¹‰çš„ `CodeGenDSA` ç±»ï¼š

```cpp
class CodeGenDSA : public CodeGenC {
public:
    void VisitStmt_(const CallNode* op) override {
        if (op->op.same_as(StringImm("dsa.dma_copy"))) {
            // ç¿»è¯‘ä¸ºå‚å•† C åº“çš„å‡½æ•°è°ƒç”¨
            this->stream << "vendor_lib_dma_copy("
                       << this->GetVarName(op->args[0]) << ", "
                       << this->GetVarName(op->args[1]) << ");\n";
        } else if (op->op.same_as(StringImm("dsa.mma"))) {
            this->stream << "vendor_lib_mma("
                       << this->GetVarName(op->args[0]) << ", "
                       << this->GetVarName(op->args[1]) << ", "
                       << this->GetVarName(op->args[2]) << ");\n";
        } else {
            CodeGenC::VisitStmt_(op);
        }
    }
};
```

### ç¬¬å››æ­¥ï¼šç¼–è¯‘å’Œæ‰§è¡Œ

```python
import tasklevel_compiler as tlc

# ç¼–è¯‘ï¼šé€»è¾‘ + æ˜ å°„ â†’ é«˜æ€§èƒ½ä»£ç 
kernel = tlc.compile(
    logic_file="gemm_logic.py",
    mapping_file="gemm_on_nvidia_gpu.mapping.yaml"
)

# æ‰§è¡Œ
a = torch.randn(1024, 1024, device="cuda", dtype=torch.float16)
b = torch.randn(1024, 1024, device="cuda", dtype=torch.float16)
c = kernel(a, b)
```

## ğŸ¯ è®¾è®¡ç›®æ ‡ï¼šå¤šç¡¬ä»¶åç«¯æ”¯æŒ

æˆ‘ä»¬çš„æ¡†æ¶è®¾è®¡ç›®æ ‡æ˜¯é€šè¿‡ç¼–å†™ç›¸åº”çš„æ˜ å°„æ–‡ä»¶å’Œ CodeGen æ‰©å±•ï¼Œæ”¯æŒå„ç§ç¡¬ä»¶å¹³å°ï¼š

- **NVIDIA GPUs**
- **AMD GPUs**:
- **DSAç¡¬ä»¶**
- **CPU**

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šTileLangå°†é€»è¾‘å’Œç­–ç•¥**æ··åˆ**åœ¨Pythonä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†å…¶**å½»åº•åˆ†ç¦»**ï¼Œç®—æ³•é€»è¾‘ä¸ç¡¬ä»¶ä¼˜åŒ–å®Œå…¨è§£è€¦ï¼Œå¼€å‘è€…åªéœ€ï¼š
- ç¼–å†™ä¸€æ¬¡**ç¡¬ä»¶æ— å…³çš„ç®—æ³•é€»è¾‘**ï¼ˆ`.py` æ–‡ä»¶ï¼‰
- ä¸ºæ¯ä¸ªç›®æ ‡ç¡¬ä»¶ç¼–å†™**è½»é‡çº§çš„æ˜ å°„æ–‡ä»¶**ï¼ˆ`.yaml` æ–‡ä»¶ï¼‰

**çº¿æ€§æ‰©å±•æ€§**ï¼šNä¸ªç®—æ³• Ã— Mä¸ªç¡¬ä»¶ = N+Mä¸ªæ–‡ä»¶ï¼ˆè€ŒéNÃ—Mä¸ªä»£ç å®ç°ï¼‰

**ä¸“å®¶åä½œ**ï¼šç®—æ³•ä¸“å®¶ä¸“æ³¨é€»è¾‘å®ç°ï¼Œç¡¬ä»¶ä¸“å®¶ä¸“æ³¨æ€§èƒ½æ˜ å°„ï¼Œå„å¸å…¶èŒ

## ğŸ”® æœªæ¥å±•æœ›ï¼šè‡ªåŠ¨ä¼˜åŒ–æ¢ç´¢

### ä»æ‰‹åŠ¨æ˜ å°„åˆ°æ™ºèƒ½ç¼–è¯‘

ç¬¬ä¸€é˜¶æ®µæ„å»ºåšå›ºçš„æ‰‹åŠ¨æ¡†æ¶ï¼Œç¬¬äºŒé˜¶æ®µç›®æ ‡æ˜¯å®ç°**è‡ªåŠ¨åŒ–çš„æ€§èƒ½è°ƒä¼˜ç³»ç»Ÿ**ï¼š

```yaml
# å¯æœç´¢çš„æ˜ å°„æ–‡ä»¶ç¤ºä¾‹
tunables:
  block_size_M: !tune {type: choice, values: [64, 128, 256]}
  pipeline_depth: !tune {type: choice, values: [2, 3, 4, 5]}
leaf_task_bindings:
  gemm_leaf_logic: !tune {type: choice, values: [gemm_leaf_tensorcore, gemm_leaf_simt]}
```

é€šè¿‡è¿™ä¸ªæ¸è¿›å¼çš„ç ”ç©¶è·¯å¾„ï¼Œæˆ‘ä»¬å°†å®ç°ä»æ‰‹åŠ¨çš„é«˜æ€§èƒ½æ¡†æ¶åˆ°çœŸæ­£æ„ä¹‰ä¸Šçš„æ™ºèƒ½ç¼–è¯‘ç³»ç»Ÿçš„èœ•å˜ã€‚

## ğŸ¤ å‚ä¸é¡¹ç›®

> **ğŸŒŸ å¯»æ‰¾æ—©æœŸè´¡çŒ®è€…**ï¼šé¡¹ç›®æ­£åœ¨å¯åŠ¨é˜¶æ®µï¼Œè¿™æ˜¯å‚ä¸å¼€æºé¡¹ç›®æ—©æœŸå»ºè®¾çš„ç»ä½³æœºä¼šï¼

æˆ‘ä»¬æ¬¢è¿ç¤¾åŒºå‚ä¸ï¼æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åŠ å…¥ï¼š

- **ğŸ’¡ è®¾è®¡è®¨è®º**: åœ¨ Issues ä¸­åˆ†äº«å¯¹æ¶æ„è®¾è®¡çš„æƒ³æ³•å’Œå»ºè®®
- **ğŸ“‹ éœ€æ±‚æ”¶é›†**: å‘Šè¯‰æˆ‘ä»¬æ‚¨å¸Œæœ›æ”¯æŒçš„ç¡¬ä»¶å’Œåº”ç”¨åœºæ™¯
- **ğŸ‘€ å…³æ³¨è¿›å±•**: Star æœ¬é¡¹ç›®ï¼Œè·å–æœ€æ–°å¼€å‘åŠ¨æ€
- **ğŸ“ æ—©æœŸè´¡çŒ®**: ç­‰é¡¹ç›®å¯åŠ¨åå‚ä¸ä»£ç å¼€å‘
- **ğŸ¯ ç¡¬ä»¶ä¸“ä¸šçŸ¥è¯†**: å¦‚æœæ‚¨æ˜¯æŸä¸ªç¡¬ä»¶å¹³å°çš„ä¸“å®¶ï¼Œæ¬¢è¿åˆ†äº«æ˜ å°„æ–‡ä»¶çš„è®¾è®¡å»ºè®®

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache License 2.0](./LICENSE) å¼€æºè®¸å¯è¯ã€‚

## ğŸ™ è‡´è°¢

- **[TVMç¤¾åŒº](https://tvm.apache.org/)** - æä¾›äº†å¼ºå¤§çš„ç¼–è¯‘å™¨åŸºç¡€è®¾æ–½
- **[Cypress è®ºæ–‡](https://rohany.github.io/publications/pldi2025-cypress.pdf)** - å¯å‘äº†"é€»è¾‘æ˜ å°„åˆ†ç¦»"çš„æ ¸å¿ƒæ€æƒ³
- **[TileLang](https://github.com/tile-ai/tilelang)** - æä¾›äº†å®è´µçš„è®¾è®¡å‚è€ƒå’Œçµæ„Ÿ

---

<div align="center">

**â­ å¦‚æœæ‚¨å¯¹è¿™ä¸ªé¡¹ç›®æ„Ÿå…´è¶£ï¼Œè¯·ç»™æˆ‘ä»¬ä¸€ä¸ªStarå…³æ³¨è¿›å±•ï¼â­**

[ğŸ’¬ å‚ä¸è®¨è®º](https://github.com/your-org/tasklevel-lang-multibackend/issues) â€¢ 
[ğŸ“‹ æéœ€æ±‚å»ºè®®](https://github.com/your-org/tasklevel-lang-multibackend/issues)

**ğŸš€ é¡¹ç›®å¯åŠ¨æ—¶æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œå…¬å‘Šï¼Œæ¬¢è¿å±Šæ—¶å‚ä¸è´¡çŒ®ï¼**

</div> 
